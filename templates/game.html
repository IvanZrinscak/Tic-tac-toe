<!doctype html>
<title>Tic Tac Toe</title>
<h1>Tic Tac Toe - {{ dimension }}D</h1>
{% if winner is not none %}
  {% if winner == -1 %}
    <p>Draw!</p>
  {% else %}
    <p>Winner: {{ 'OX'[winner] }}</p>
  {% endif %}
  <form method="post" action="{{ url_for('reset') }}">
    <button type="submit">Play again</button>
  </form>
{% endif %}

{% if dimension == 2 %}
<table style="border-collapse: collapse;">
  {% for i in range(size) %}
  <tr>
    {% for j in range(size) %}
    <td style="width:40px;height:40px;text-align:center;border:1px solid #000;">
      {% if board[i][j] == -1 and winner is none %}
      <form method="post" action="{{ url_for('move') }}">
        <input type="hidden" name="row" value="{{ i }}">
        <input type="hidden" name="col" value="{{ j }}">
        <button style="width:40px;height:40px;"></button>
      </form>
      {% elif board[i][j] == 0 %}
      O
      {% elif board[i][j] == 1 %}
      X
      {% endif %}
    </td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>
{% elif dimension == 3 %}
<div class="scene" id="scene" style="width:{{ cube_size }}px;height:{{ cube_size }}px;">
  <div id="cube" class="board-3d" style="width:{{ cube_size }}px;height:{{ cube_size }}px;">
    <div class="cube-frame">
      <div class="face front" style="transform:translateZ({{ half }}px);"></div>
      <div class="face back" style="transform:rotateY(180deg) translateZ({{ half }}px);"></div>
      <div class="face right" style="transform:rotateY(90deg) translateZ({{ half }}px);"></div>
      <div class="face left" style="transform:rotateY(-90deg) translateZ({{ half }}px);"></div>
      <div class="face top" style="transform:rotateX(90deg) translateZ({{ half }}px);"></div>
      <div class="face bottom" style="transform:rotateX(-90deg) translateZ({{ half }}px);"></div>
    </div>
    {% for i in range(size) %}
      {% for j in range(size) %}
        {% for k in range(size) %}
          <div class="cell" style="transform: translate3d({{ j*50 }}px, {{ i*50 }}px, {{ k*50 }}px);">
            <div class="cube-box">
              <div class="face front"></div>
              <div class="face back"></div>
              <div class="face right"></div>
              <div class="face left"></div>
              <div class="face top"></div>
              <div class="face bottom"></div>
            </div>
            {% if board[i][j][k] == -1 and winner is none %}
            <form method="post" action="{{ url_for('move') }}">
              <input type="hidden" name="row" value="{{ i }}">
              <input type="hidden" name="col" value="{{ j }}">
              <input type="hidden" name="layer" value="{{ k }}">
              <button style="width:40px;height:40px;"></button>
            </form>
            {% elif board[i][j][k] == 0 %}
            <div class="marker o"></div>
            {% elif board[i][j][k] == 1 %}
            <div class="marker x"></div>
            {% endif %}
          </div>
        {% endfor %}
      {% endfor %}
    {% endfor %}
  </div>
</div>
<style>
  .scene { perspective: 600px; margin:20px auto; }
  .board-3d { position: relative; transform-style: preserve-3d; margin:auto; }
  .cube-frame, .cube-box {
    position:absolute;
    width:100%;
    height:100%;
    transform-style: preserve-3d;
    pointer-events:none;
  }
  .cube-box { width:40px; height:40px; }
  .cube-frame .face, .cube-box .face {
    position:absolute;
    width:100%;
    height:100%;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(0,0,0,0.3);
  }
  .cube-box .front { transform: translateZ(20px); }
  .cube-box .back { transform: rotateY(180deg) translateZ(20px); }
  .cube-box .right { transform: rotateY(90deg) translateZ(20px); }
  .cube-box .left { transform: rotateY(-90deg) translateZ(20px); }
  .cube-box .top { transform: rotateX(90deg) translateZ(20px); }
  .cube-box .bottom { transform: rotateX(-90deg) translateZ(20px); }
  .cell {
    position:absolute;
    width:40px;
    height:40px;
    transform-style: preserve-3d;
  }
  .marker {
    position:absolute;
    width:40px;
    height:40px;
    left:0;
    top:0;
    transform-style:preserve-3d;
  }
  .marker.o::before,
  .marker.o::after {
    content:"";
    position:absolute;
    width:30px;
    height:30px;
    left:5px;
    top:5px;
    border:5px solid blue;
    border-radius:50%;
  }
  .marker.o::before { transform:translateZ(-2px); }
  .marker.o::after { transform:translateZ(2px); }
  .marker.x::before,
  .marker.x::after {
    content:"";
    position:absolute;
    width:5px;
    height:40px;
    left:17.5px;
    top:0;
    background:red;
  }
  .marker.x::before { transform:translateZ(-2px) rotateZ(45deg); }
  .marker.x::after { transform:translateZ(2px) rotateZ(-45deg); }
</style>
<script>
const cube = document.getElementById('cube');
const scene = document.getElementById('scene');
let rotX = -20;
let rotY = 30;
let dragging = false;
let lastX = 0;
let lastY = 0;
function update(){
  cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
}
scene.addEventListener('mousedown', e => {
  dragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
});
document.addEventListener('mousemove', e => {
  if(!dragging) return;
  const dx = e.clientX - lastX;
  const dy = e.clientY - lastY;
  rotY += dx * 0.5;
  rotX -= dy * 0.5;
  lastX = e.clientX;
  lastY = e.clientY;
  update();
});
document.addEventListener('mouseup', () => { dragging = false; });
update();
</script>
{% endif %}

<p><a href="{{ url_for('index') }}">Choose dimension</a></p>
